---
title: 字符串的扩展
date: 2020-10-14 16:18:15
tags: ECMASCript
---

# 字符串的扩展

### 01.字符的unicode表示法

- ES6加强对unicode的支持，允许采用\uxxxx形式表示字符

  - 但这种表示方法只限于码点在\u000~\uFFFF之间的字符，超出这个范围的字符，必须用两个双字节的形式表示

    ```javascript
    "\uD842\uDFB7"
    // "𠮷"
    
    "\u20BB7"
    // " 7"
    ```

  - 将码点放入大括号就能正确解读该字符

    ```javascript
    "\u{20BB7}"
    // "𠮷"
    
    "\u{41}\u{42}\u{43}"
    // "ABC"
    
    let hello = 123;
    hell\u{6F} // 123
    
    '\u{1F680}' === '\uD83D\uDE80'
    // true
    ```

  - JavaScript中一共有6种方法可以表示一个字符

    ```javascript
    '\z' === 'z'  // true
    '\172' === 'z' // true
    '\x7A' === 'z' // true
    '\u007A' === 'z' // true
    '\u{7A}' === 'z' // true
    ```

### 02.字符串遍历器接口

- ES6为字符串添加遍历接口，是字符串可以被for...of循环遍历

  ```javascript
  for (let codePoint of 'foo') {
    console.log(codePoint)
  }
  // "f"
  // "o"
  // "o"
  ```

- 此遍历器最大优点是可以识别大于0xFFFF码点，传统for循环无法识别这样的码点

  ```javascript
  let text = String.fromCodePoint(0x20BB7);
  
  for (let i = 0; i < text.length; i++) {
    console.log(text[i]);
  }
  // " "
  // " "
  
  for (let i of text) {
    console.log(i);
  }
  // "𠮷"
  ```

### 03.直接输入U+2028 和 U+2029 

- JavaScript 字符串允许直接输入字符，以及输入字符的转义形式。举例来说，“中”的 Unicode 码点是 U+4e2d，你可以直接在字符串里面输入这个汉字，也可以输入它的转义形式`\u4e2d`，两者是等价的。

  ```javascript
  '中' === '\u4e2d' // true
  ```

  - 但是，JavaScript 规定有5个字符，不能在字符串里面直接使用，只能使用转义形式。
    - U+005C：反斜杠（reverse solidus)
    - U+000D：回车（carriage return）
    - U+2028：行分隔符（line separator）
    - U+2029：段分隔符（paragraph separator）
    - U+000A：换行符（line feed）

- 字符串里面不能直接包含反斜杠，一定要转义写成`\\`或者`\u005c`。

  - JSON 格式允许字符串里面直接使用 U+2028（行分隔符）和 U+2029（段分隔符），服务器输出的 JSON 被`JSON.parse`解析，就有可能直接报错。

    ```javascript
    const json = '"\u2028"';
    JSON.parse(json); // 可能报错
    
    为了消除这个报错，ES2019 允许 JavaScript 字符串直接输入 U+2028（行分隔符）和 U+2029（段分隔符）。
    ```

  - 注意，模板字符串现在就允许直接输入这两个字符。另外，正则表达式依然不允许直接输入这两个字符，这是没有问题的，因为 JSON 本来就不允许直接包含正则表达式。

### 04.JSON.stringify() 的改造

- JSON 数据必须是 UTF-8 编码。UTF-8 标准规定，`0xD800`到`0xDFFF`之间的码点，不能单独使用，必须配对使用。而`JSON.stringify()`方法有可能返回不符合 UTF-8 标准的字符串。

- 为了保证返回的是合法的 UTF-8 字符，遇到`0xD800`到`0xDFFF`之间的单个码点，或者不存在的配对形式，它会返回转义字符串。

  ```javascript
  JSON.stringify('\u{D834}') // ""\\uD834""
  JSON.stringify('\uDF06\uD834') // ""\\udf06\\ud834""
  ```

### 05.模版字符串

- 传统模版：

  ```javascript
  $('#result').append(
    'There are <b>' + basket.count + '</b> ' +
    'items in your basket, ' +
    '<em>' + basket.onSale +
    '</em> are on sale!'
  );
  ```

- ES6:

  ```javascript
  $('#result').append(`
    There are <b>${basket.count}</b> items
     in your basket, <em>${basket.onSale}</em>
    are on sale!
  `);
  ```

- 模版字符串：用反引号（`）标识。可以当作普通字符串使用，可以用来定义多行字符串，或者在字符串中嵌入变量。

  ```javascript
  // 普通字符串
  `In JavaScript '\n' is a line-feed.`
  
  // 多行字符串
  `In JavaScript this is
   not legal.`
  
  console.log(`string text line 1
  string text line 2`);
  
  // 字符串中嵌入变量
  let name = "Bob", time = "today";
  `Hello ${name}, how are you ${time}?`
  ```

- 如果在模板字符串中需要使用反引号，则前面要用反斜杠转义。

- 如果使用模板字符串表示多行字符串，所有的空格和缩进都会被保留在输出之中。如果不想要这个换行，可以使用`trim`方法消除。

- 模板字符串中嵌入变量，需要将变量名写在`${}`之中。

  ```javascript
  function authorize(user, action) {
    if (!user.hasPrivilege(action)) {
      throw new Error(
        // 传统写法为
        // 'User '
        // + user.name
        // + ' is not authorized to do '
        // + action
        // + '.'
        `User ${user.name} is not authorized to do ${action}.`);
    }
  }
  ```

- 大括号内部可以放入任意的 JavaScript 表达式，可以进行运算，以及引用对象属性。

  ```javascript
  let x = 1;
  let y = 2;
  
  `${x} + ${y} = ${x + y}`
  // "1 + 2 = 3"
  
  `${x} + ${y * 2} = ${x + y * 2}`
  // "1 + 4 = 5"
  
  let obj = {x: 1, y: 2};
  `${obj.x + obj.y}`
  // "3"
  ```

- 模板字符串之中还能调用函数。

  ```javascript
  function fn() {
    return "Hello World";
  }
  
  `foo ${fn()} bar`
  // foo Hello World bar
  ```

  - 如果大括号中的值不是字符串，将按照一般的规则转为字符串。比如，大括号中是一个对象，将默认调用对象的`toString`方法。

- 如果模板字符串中的变量没有声明，将报错。

  ```javascript
  // 变量place没有声明
  let msg = `Hello, ${place}`;
  // 报错
  ```

- 由于模板字符串的大括号内部，就是执行 JavaScript 代码，因此如果大括号内部是一个字符串，将会原样输出。

  ```javascript
  `Hello ${'World'}`
  // "Hello World"
  ```

- 模板字符串还能嵌套。

### 06.实例：模板编译

- JavaScript 代码，使用`<%= ... %>`输出 JavaScript 表达式。

- 编译模版流程

  ```mermaid
  graph LR;
      正则转换为表达式字符串-->template封装到函数返回;
      template封装到函数返回-->拼装成一个模版编译compile;
  ```

  

### 07.标签模版

- 标签模板其实不是模板，而是函数调用的一种特殊形式。“标签”指的就是函数，紧跟在后面的模板字符串就是它的参数。

- 如果模板字符里面有变量，会将模板字符串先处理成多个参数，再调用函数。

  ```javascript
  let a = 5;
  let b = 10;
  
  tag`Hello ${ a + b } world ${ a * b }`;
  // 等同于
  tag(['Hello ', ' world ', ''], 15, 50);
  ```

- “标签模板”的一个重要应用，就是过滤 HTML 字符串，防止用户输入恶意内容。

  ```javascript
  let message =
    SaferHTML`<p>${sender} has sent you a message.</p>`;
  
  function SaferHTML(templateData) {
    let s = templateData[0];
    for (let i = 1; i < arguments.length; i++) {
      let arg = String(arguments[i]);
  
      // Escape special characters in the substitution.
      s += arg.replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;");
  
      // Don't escape special characters in the template.
      s += templateData[i];
    }
    return s;
  }
  
  sender变量往往是用户提供的，经过SaferHTML函数处理，里面的特殊字符都会被转义。
  ```

- 标签模板的另一个应用，就是多语言转换（国际化处理）。

  ```javascript
  i18n`Welcome to ${siteName}, you are visitor number ${visitorNumber}!`
  // "欢迎访问xxx，您是第xxxx位访问者！"
  ```

- 通过标签函数为模版字符串添加条件判断、循环等功能

### 08.模板字符串的限制

- 可以内嵌其他语言。但是，模板字符串默认会将字符串转义，导致无法嵌入其他语言。
- 标签模版嵌入LaTEX代码会报错，因为模版字符串会转义
- ES2018遇到不合法字符串转义返回undefined，raw属性可以得到原始字符串